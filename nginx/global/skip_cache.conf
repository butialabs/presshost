
# Initialize skip cache variable
set $skip_cache 0;

# POST requests should always go to PHP (forms, comments, etc.)
if ($request_method = POST) {
	set $skip_cache 1;
}

# URLs with query strings (except specific allowed ones)
if ($query_string != "") {
	set $skip_cache 1;
}

# Allow caching for specific query parameters that don't change content
if ($args ~* "^(utm_source|utm_medium|utm_campaign|utm_content|utm_term|fbclid|gclid)=") {
    set $skip_cache 0;
}

# Skip cache for logged in users (comprehensive cookie check)
if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
    set $skip_cache 1;
}


# Skip cache for specific admin and system URLs
if ($request_uri ~* "/(wp-admin/|wp-login\.php|wp-register\.php|wp-cron\.php|wp-comments-post\.php|wp-trackback\.php|wp-mail\.php|wp-links-opml\.php|wp-locations\.php|sitemap(_index)?\.xml|[a-z0-9_-]+-sitemap([0-9]+)?\.xml)") {
    set $skip_cache 1;
}

# Skip cache for JSON API and REST API
if ($request_uri ~* "/(wp-json|rest-route)/") {
    set $skip_cache 1;
}

# Skip cache for AJAX requests
if ($http_x_requested_with = "XMLHttpRequest") {
    set $skip_cache 1;
}

# Skip cache for NGINX Helper plugin operations
if ($request_uri ~* "/(nginx-helper|rt-nginx-helper)/") {
    set $skip_cache 1;
}

# Skip cache for cache purge endpoints
if ($request_uri ~* "/nginx-helper-purge") {
    set $skip_cache 1;
}

# Skip cache for preview URLs and staging
if ($args ~* "(preview=true|preview_id=|preview_nonce=|s=)") {
    set $skip_cache 1;
}

# Skip cache for search results
if ($request_uri ~* "/\?s=|/search/") {
    set $skip_cache 1;
}

# Skip cache for feeds
if ($request_uri ~* "/(feed|rdf|rss|atom)/?$") {
    set $skip_cache 1;
}

# Skip cache for specific file types that should be dynamic
if ($request_uri ~* "\.(php|phtml|asp|aspx|jsp)$") {
    set $skip_cache 1;

}